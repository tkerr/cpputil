/******************************************************************************
 * Checksum.c
 * Copyright (c) 2015 Thomas Kerr
 *
 * Released under the MIT License (MIT). 
 * See http://opensource.org/licenses/MIT
 *
 * Modification History:
 *
 * 09/18/2015 - Tom Kerr
 * Added ipv4_checksum().
 *
 * 09/16/2015 - Tom Kerr
 * Created.
 ******************************************************************************/

/**
 * @file
 * @brief
 * Checksum functions for detecting errors in blocks of data.
 */
 
/******************************************************************************
 * System include files.
 ******************************************************************************/


/******************************************************************************
 * Local include files.
 ******************************************************************************/
#include "checksum.h"
#include "UnionTypeDefs.h"


/******************************************************************************
 * Forward references.
 ******************************************************************************/


/******************************************************************************
 * Local definitions.
 ******************************************************************************/


/******************************************************************************
 * Local data.
 ******************************************************************************/


/******************************************************************************
 * Public functions.
 ******************************************************************************/
 
/**************************************
 * checksum
 **************************************/
char checksum(const void* pData, size_t len)
{
    char* ptr = (char*) pData;
    char  sum = 0;
    do {sum += *ptr++;} while (--len);
    return ~sum + 1;
}


/**************************************
 * ipv4_checksum
 **************************************/
uint16_t ipv4_checksum(const void* pData, size_t len)
{
    uint32u_t sum;
    
    uint16_t* ptr = (uint16_t*) pData;
    size_t i = len / sizeof(uint16_t);
    sum.v = 0;
    do {sum.v += *ptr++;} while (--i);
    
    // If a carry exists, add it back to the checksum.
    while (sum.w[1] != 0) {sum.v = sum.w[0] + sum.w[1];}
    
    return ~sum.w[0];
}


/*****************************************************************************
 * Private functions.
 ******************************************************************************/
 

// End of file.
